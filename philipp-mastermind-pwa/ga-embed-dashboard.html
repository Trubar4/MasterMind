<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mastermind Analytics Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    .header h1 {
      margin: 0;
      color: #333;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
      gap: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 15px;
    }
    .card-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    .stat-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
    }
    .stat-card {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #6200EE;
      margin: 5px 0;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
    }
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    button {
      background-color: #4285F4;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #3367D6;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #6200EE;
      border-radius: 50%;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none !important;
    }
    .error-message {
      color: #d32f2f;
      background-color: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: none;
    }
    .note {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #3367D6;
    }
    #date-range {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    #date-range select {
      padding: 8px;
      margin-left: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Mastermind Analytics Dashboard</h1>
      <div id="auth-container">
        <div id="g_id_onload"
             data-client_id="82857070912-7n6f5ekb5161f02mupl5d1d7b5j3656f.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>
        <button id="sign-out" class="hidden" onclick="signOut()">Sign Out</button>
      </div>
    </div>

    <div id="error-message" class="error-message"></div>

    <div id="auth-message" class="note">
      <p>To view analytics data, please sign in with your Google account that has access to your Google Analytics property.</p>
    </div>

    <div id="dashboard-content" class="hidden">
      <div id="date-range">
        <label for="period-selector">Time period:</label>
        <select id="period-selector" onchange="refreshData()">
          <option value="7daysAgo">Last 7 days</option>
          <option value="30daysAgo" selected>Last 30 days</option>
          <option value="90daysAgo">Last 90 days</option>
          <option value="365daysAgo">Last 365 days</option>
        </select>
      </div>

      <div class="dashboard">
        <!-- Overview Stats -->
        <div class="card">
          <div class="card-header">Overview</div>
          <div class="stat-container">
            <div class="stat-card">
              <div class="stat-value" id="active-users">0</div>
              <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="new-users">0</div>
              <div class="stat-label">New Users</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="avg-engagement">0s</div>
              <div class="stat-label">Avg. Engagement</div>
            </div>
          </div>
        </div>

        <!-- Event Stats -->
        <div class="card">
          <div class="card-header">Events</div>
          <div class="stat-container">
            <div class="stat-card">
              <div class="stat-value" id="total-events">0</div>
              <div class="stat-label">Total Events</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="game-starts">0</div>
              <div class="stat-label">Game Starts</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="conversion-rate">0%</div>
              <div class="stat-label">Completion Rate</div>
            </div>
          </div>
        </div>

        <!-- Users Chart -->
        <div class="card">
          <div class="card-header">Users Over Time</div>
          <div class="chart-container">
            <canvas id="users-chart"></canvas>
          </div>
        </div>

        <!-- Events Chart -->
        <div class="card">
          <div class="card-header">Events Over Time</div>
          <div class="chart-container">
            <canvas id="events-chart"></canvas>
          </div>
        </div>

        <!-- Device Distribution -->
        <div class="card">
          <div class="card-header">Device Distribution</div>
          <div class="chart-container">
            <canvas id="device-chart"></canvas>
          </div>
        </div>

        <!-- Browser Distribution -->
        <div class="card">
          <div class="card-header">Browser Distribution</div>
          <div class="chart-container">
            <canvas id="browser-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
  </div>

  <script>
    // Configuration
    const GA4_PROPERTY_ID = '486860865'; // Your GA4 Property ID
    const DEFAULT_PERIOD = '30daysAgo';
    
    // Charts
    const charts = {};
    let accessToken = null;
    
    // Utility function to format numbers
    function formatNumber(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    // Utility function to format time
    function formatTime(seconds) {
      if (!seconds) return "0s";
      seconds = Math.round(seconds);
      if (seconds < 60) return seconds + 's';
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return minutes + 'm ' + (remainingSeconds > 0 ? remainingSeconds + 's' : '');
    }
    
    // Display error message
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      hideLoading();
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 8000);
    }
    
    // Show loading overlay
    function showLoading() {
      document.getElementById('loading-overlay').style.display = 'flex';
    }
    
    // Hide loading overlay
    function hideLoading() {
      document.getElementById('loading-overlay').style.display = 'none';
    }
    
    // Handle Google sign-in callback
    function handleCredentialResponse(response) {
      const credential = response.credential;
      accessToken = credential;
      
      // Show dashboard content and hide auth message
      document.getElementById('dashboard-content').classList.remove('hidden');
      document.getElementById('auth-message').classList.add('hidden');
      document.getElementById('sign-out').classList.remove('hidden');
      
      // Hide Google sign-in button
      const signInButton = document.querySelector('.g_id_signin');
      if (signInButton) {
        signInButton.style.display = 'none';
      }
      
      // Initialize charts and load data
      initializeCharts();
      refreshData();
    }
    
    // Sign out
    function signOut() {
      accessToken = null;
      
      // Hide dashboard content and show auth message
      document.getElementById('dashboard-content').classList.add('hidden');
      document.getElementById('auth-message').classList.remove('hidden');
      document.getElementById('sign-out').classList.add('hidden');
      
      // Show Google sign-in button
      const signInButton = document.querySelector('.g_id_signin');
      if (signInButton) {
        signInButton.style.display = 'block';
      }
      
      // Re-initialize Google Sign-In
      google.accounts.id.initialize({
        client_id: '82857070912-7n6f5ekb5161f02mupl5d1d7b5j3656f.apps.googleusercontent.com',
        callback: handleCredentialResponse,
        auto_select: false
      });
      google.accounts.id.renderButton(
        document.getElementById('g_id_signin'),
        { theme: 'outline', size: 'large' }
      );
    }
    
    // Initialize charts
    function initializeCharts() {
      // Users Chart
      const usersChartCtx = document.getElementById('users-chart').getContext('2d');
      charts.usersChart = new Chart(usersChartCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Active Users',
            data: [],
            borderColor: '#4285F4',
            backgroundColor: 'rgba(66, 133, 244, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Events Chart
      const eventsChartCtx = document.getElementById('events-chart').getContext('2d');
      charts.eventsChart = new Chart(eventsChartCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Events',
            data: [],
            borderColor: '#0F9D58',
            backgroundColor: 'rgba(15, 157, 88, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Device Chart
      const deviceChartCtx = document.getElementById('device-chart').getContext('2d');
      charts.deviceChart = new Chart(deviceChartCtx, {
        type: 'pie',
        data: {
          labels: ['Desktop', 'Mobile', 'Tablet'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#4285F4', '#EA4335', '#FBBC05']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Browser Chart
      const browserChartCtx = document.getElementById('browser-chart').getContext('2d');
      charts.browserChart = new Chart(browserChartCtx, {
        type: 'pie',
        data: {
          labels: ['Chrome', 'Safari', 'Firefox', 'Edge', 'Other'],
          datasets: [{
            data: [0, 0, 0, 0, 0],
            backgroundColor: ['#4285F4', '#0F9D58', '#EA4335', '#FBBC05', '#757575']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
    }
    
    // Refresh all data
    function refreshData() {
      if (!accessToken) return;
      
      showLoading();
      
      const period = document.getElementById('period-selector').value || DEFAULT_PERIOD;
      
      Promise.all([
        fetchUsersData(period),
        fetchEventsData(period),
        fetchTimeSeriesData(period),
        fetchDeviceData(period),
        fetchBrowserData(period)
      ])
      .then(() => {
        hideLoading();
      })
      .catch(error => {
        console.error('Error fetching data:', error);
        showError('Error fetching analytics data: ' + error.message);
        hideLoading();
        loadDemoData();
      });
    }
    
    // Fetch users data
    async function fetchUsersData(period) {
      try {
        // Get user metrics data
        const data = await queryGA4Data({
          dateRanges: [{ startDate: period, endDate: 'today' }],
          metrics: [
            { name: 'activeUsers' },
            { name: 'newUsers' },
            { name: 'averageSessionDuration' }
          ]
        });
        
        if (data && data.rows && data.rows.length > 0) {
          const activeUsers = parseInt(data.rows[0].metricValues[0].value);
          const newUsers = parseInt(data.rows[0].metricValues[1].value);
          const avgEngagement = parseFloat(data.rows[0].metricValues[2].value);
          
          document.getElementById('active-users').textContent = formatNumber(activeUsers);
          document.getElementById('new-users').textContent = formatNumber(newUsers);
          document.getElementById('avg-engagement').textContent = formatTime(avgEngagement);
        }
      } catch (error) {
        console.error('Error fetching users data:', error);
        throw error;
      }
    }
    
    // Fetch events data
    async function fetchEventsData(period) {
      try {
        // Get event metrics
        const data = await queryGA4Data({
          dateRanges: [{ startDate: period, endDate: 'today' }],
          dimensions: [{ name: 'eventName' }],
          metrics: [{ name: 'eventCount' }]
        });
        
        let totalEvents = 0;
        let gameStarts = 0;
        let gameEnds = 0;
        
        if (data && data.rows) {
          data.rows.forEach(row => {
            const eventName = row.dimensionValues[0].value;
            const count = parseInt(row.metricValues[0].value);
            
            totalEvents += count;
            
            if (eventName === 'game_start') {
              gameStarts = count;
            } else if (eventName === 'game_end') {
              gameEnds = count;
            }
          });
        }
        
        const conversionRate = gameStarts > 0 ? (gameEnds / gameStarts) * 100 : 0;
        
        document.getElementById('total-events').textContent = formatNumber(totalEvents);
        document.getElementById('game-starts').textContent = formatNumber(gameStarts);
        document.getElementById('conversion-rate').textContent = conversionRate.toFixed(1) + '%';
      } catch (error) {
        console.error('Error fetching events data:', error);
        throw error;
      }
    }
    
    // Fetch time series data
    async function fetchTimeSeriesData(period) {
      try {
        // Get users time series
        const usersData = await queryGA4Data({
          dateRanges: [{ startDate: period, endDate: 'today' }],
          dimensions: [{ name: 'date' }],
          metrics: [{ name: 'activeUsers' }],
          orderBys: [{ dimension: { dimensionName: 'date' } }]
        });
        
        // Get events time series
        const eventsData = await queryGA4Data({
          dateRanges: [{ startDate: period, endDate: 'today' }],
          dimensions: [{ name: 'date' }],
          metrics: [{ name: 'eventCount' }],
          orderBys: [{ dimension: { dimensionName: 'date' } }]
        });
        
        // Process users data
        const userLabels = [];
        const userData = [];
        
        if (usersData && usersData.rows) {
          usersData.rows.forEach(row => {
            const dateStr = row.dimensionValues[0].value;
            const count = parseInt(row.metricValues[0].value);
            
            // Format date as MM/DD
            const month = dateStr.substr(4, 2);
            const day = dateStr.substr(6, 2);
            userLabels.push(`${month}/${day}`);
            userData.push(count);
          });
        }
        
        // Process events data
        const eventLabels = [];
        const eventData = [];
        
        if (eventsData && eventsData.rows) {
          eventsData.rows.forEach(row => {
            const dateStr = row.dimensionValues[0].value;
            const count = parseInt(row.metricValues[0].value);
            
            // Format date as MM/DD
            const month = dateStr.substr(4, 2);
            const day = dateStr.substr(6, 2);
            eventLabels.push(`${month}/${day}`);
            eventData.push(count);
          });
        }
        
        // Update charts
        charts.usersChart.data.labels = userLabels;
        charts.usersChart.data.datasets[0].data = userData;
        charts.usersChart.update();
        
        charts.eventsChart.data.labels = eventLabels;
        charts.eventsChart.data.datasets[0].data = eventData;
        charts.eventsChart.update();
      } catch (error) {
        console.error('Error fetching time series data:', error);
        throw error;
      }
    }
    
    // Fetch device data
    async function fetchDeviceData(period) {
      try {
        const data = await queryGA4Data({
          dateRanges: [{ startDate: period, endDate: 'today' }],
          dimensions: [{ name: 'deviceCategory' }],
          metrics: [{ name: 'activeUsers' }]
        });
        
        let desktopCount = 0;
        let mobileCount = 0;
        let tabletCount = 0;
        
        if (data && data.rows) {
          data.rows.forEach(row => {
            const deviceType = row.dimensionValues[0].value;
            const count = parseInt(row.metricValues[0].value);
            
            if (deviceType === 'desktop') {
              desktopCount = count;
            } else if (deviceType === 'mobile') {
              mobileCount = count;
            } else if (deviceType === 'tablet') {
              tabletCount = count;
            }
          });
        }
        
        // Update chart
        charts.deviceChart.data.datasets[0].data = [desktopCount, mobileCount, tabletCount];
        charts.deviceChart.update();
      } catch (error) {
        console.error('Error fetching device data:', error);
        throw error;
      }
    }
    
    // Fetch browser data
    async function fetchBrowserData(period) {
      try {
        const data = await queryGA4Data({
          dateRanges: [{ startDate: period, endDate: 'today' }],
          dimensions: [{ name: 'browser' }],
          metrics: [{ name: 'activeUsers' }]
        });
        
        let chromeCount = 0;
        let safariCount = 0;
        let firefoxCount = 0;
        let edgeCount = 0;
        let otherCount = 0;
        
        if (data && data.rows) {
          data.rows.forEach(row => {
            const browser = row.dimensionValues[0].value.toLowerCase();
            const count = parseInt(row.metricValues[0].value);
            
            if (browser.includes('chrome')) {
              chromeCount += count;
            } else if (browser.includes('safari')) {
              safariCount += count;
            } else if (browser.includes('firefox')) {
              firefoxCount += count;
            } else if (browser.includes('edge')) {
              edgeCount += count;
            } else {
              otherCount += count;
            }
          });
        }
        
        // Update chart
        charts.browserChart.data.datasets[0].data = [chromeCount, safariCount, firefoxCount, edgeCount, otherCount];
        charts.browserChart.update();
      } catch (error) {
        console.error('Error fetching browser data:', error);
        throw error;
      }
    }
    
    // Query the GA4 Data API
    async function queryGA4Data(requestBody) {
      if (!accessToken) {
        throw new Error('Not authenticated. Please sign in first.');
      }
      
      try {
        const response = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${GA4_PROPERTY_ID}:runReport`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error ? errorData.error.message : `HTTP Error ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error querying GA4 data:', error);
        throw error;
      }
    }
    
    // Load demo data if API fails
    function loadDemoData() {
      console.log('Loading demo data as fallback');
      
      // Update stats
      document.getElementById('active-users').textContent = '752';
      document.getElementById('new-users').textContent = '314';
      document.getElementById('avg-engagement').textContent = '3m 45s';
      document.getElementById('total-events').textContent = '4,582';
      document.getElementById('game-starts').textContent = '843';
      document.getElementById('conversion-rate').textContent = '78.5%';
      
      // Generate demo time series data
      const demoLabels = [];
      const demoUserData = [];
      const demoEventData = [];
      
      const today = new Date();
      for (let i = 30; i > 0; i--) {
        const date = new Date();
        date.setDate(today.getDate() - i);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        demoLabels.push(`${month}/${day}`);
        demoUserData.push(Math.floor(Math.random() * 40) + 10);
        demoEventData.push(Math.floor(Math.random() * 200) + 50);
      }
      
      // Update charts
      charts.usersChart.data.labels = demoLabels;
      charts.usersChart.data.datasets[0].data = demoUserData;
      charts.usersChart.update();
      
      charts.eventsChart.data.labels = demoLabels;
      charts.eventsChart.data.datasets[0].data = demoEventData;
      charts.eventsChart.update();
      
      charts.deviceChart.data.datasets[0].data = [60, 35, 5];
      charts.deviceChart.update();
      
      charts.browserChart.data.datasets[0].data = [45, 25, 15, 10, 5];
      charts.browserChart.update();
    }
  </script>
</body>
</html>